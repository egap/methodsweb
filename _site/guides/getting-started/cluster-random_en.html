<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.247">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jake Bowers">

<title>EGAP Learning - 10 Things to Know About Cluster Randomization</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">EGAP Learning</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../guides.html">
 <span class="menu-text">Methods guides</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-clustering-is" id="toc-what-clustering-is" class="nav-link active" data-scroll-target="#what-clustering-is">1 What clustering is</a></li>
  <li><a href="#why-clustering-can-matter-i-information-reduction" id="toc-why-clustering-can-matter-i-information-reduction" class="nav-link" data-scroll-target="#why-clustering-can-matter-i-information-reduction">2 Why clustering can matter I: information reduction</a></li>
  <li><a href="#what-to-do-about-information-reduction" id="toc-what-to-do-about-information-reduction" class="nav-link" data-scroll-target="#what-to-do-about-information-reduction">3 What to do about information reduction</a></li>
  <li><a href="#why-clustering-can-matter-ii-different-cluster-sizes-and-bias" id="toc-why-clustering-can-matter-ii-different-cluster-sizes-and-bias" class="nav-link" data-scroll-target="#why-clustering-can-matter-ii-different-cluster-sizes-and-bias">4 Why clustering can matter II: different cluster sizes and bias</a></li>
  <li><a href="#what-to-do-about-different-cluster-sizes" id="toc-what-to-do-about-different-cluster-sizes" class="nav-link" data-scroll-target="#what-to-do-about-different-cluster-sizes">5 What to do about different cluster sizes</a></li>
  <li><a href="#why-clustering-can-matter-iii-within-cluster-spillovers" id="toc-why-clustering-can-matter-iii-within-cluster-spillovers" class="nav-link" data-scroll-target="#why-clustering-can-matter-iii-within-cluster-spillovers">6 Why clustering can matter III: within-cluster spillovers</a></li>
  <li><a href="#what-to-do-about-within-cluster-spillovers" id="toc-what-to-do-about-within-cluster-spillovers" class="nav-link" data-scroll-target="#what-to-do-about-within-cluster-spillovers">7 What to do about within-cluster spillovers</a></li>
  <li><a href="#performance-of-design--vs.-model-based-analyses-of-clustered-studies" id="toc-performance-of-design--vs.-model-based-analyses-of-clustered-studies" class="nav-link" data-scroll-target="#performance-of-design--vs.-model-based-analyses-of-clustered-studies">8 Performance of design- vs.&nbsp;model-based analyses of clustered studies</a></li>
  <li><a href="#power-analysis-for-clustered-designs" id="toc-power-analysis-for-clustered-designs" class="nav-link" data-scroll-target="#power-analysis-for-clustered-designs">9 Power analysis for clustered designs</a></li>
  <li><a href="#how-to-check-balance-in-clustered-designs" id="toc-how-to-check-balance-in-clustered-designs" class="nav-link" data-scroll-target="#how-to-check-balance-in-clustered-designs">10 How to check balance in clustered designs</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">10 Things to Know About Cluster Randomization</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jake Bowers </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'knitr' was built under R version 4.0.5</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'Matrix' was built under R version 4.0.5</code></pre>
</div>
</div>
<section id="what-clustering-is" class="level1">
<h1>1 What clustering is</h1>
<p>Cluster randomized<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> experiments allocate treatments to groups, but measure outcomes at the level of the individuals that compose the groups. It is this divergence between the level at which the intervention is assigned and the level at which outcomes are defined that classifies an experiment as cluster randomized.</p>
<p>Consider a study that randomly assigns villages to receive different development programs, where the well-being of households in the village is the outcome of interest. This is a clustered design because, while the treatment is assigned to the village as a whole, we are interested in outcomes defined at the household level. Or consider a study that randomly assigns certain households to receive different get-out-the-vote messages, where we are interested in the voting behavior of individuals. Because the unit of assignment for the message is the household, but the outcome is defined as individual behavior, this study is cluster randomized.</p>
<p>Now consider a study in which villages are selected at random, and 10 people from each village are assigned to treatment or control, and we measure the well-being of those individuals. In this case, the study is not cluster randomized, because the level at which treatment is assigned and the level at which outcomes are defined is the same. Suppose that a study randomly assigned villages to different development programs and then measured social cohesion in the village. Though it contains the same randomization procedure as our first example, it is not clustered because we are interested here in village-level outcomes: the level of treatment assignment and of outcome measurement is the same.</p>
<p>Clustering matters for two main reasons. On the one hand, clustering reduces the amount of information in an experiment because it restricts the number of ways that the treatment and control groups can be composed, relative to randomization at the individual level. If this fact is not taken into account, we often underestimate the variance in our estimator, leading to over-confidence in our the results of the study. On the other hand, clustering raises the question of how to combine information from different parts of the same experiment into one quantity. Especially when clusters are not of equal sizes and the potential outcomes of units within them are very different, conventional estimators will systematically produce the wrong answer due to bias. However, several approaches at the design and analysis phases can overcome the challenges posed by cluster randomized designs.</p>
</section>
<section id="why-clustering-can-matter-i-information-reduction" class="level1">
<h1>2 Why clustering can matter I: information reduction</h1>
<p>We commonly think of the information contained in studies in terms of the sample size and the characteristics of the units within the sample. Yet two studies with exactly the same sample size and the same participants could in theory contain very different amounts of information depending on whether units are clustered. This will greatly affect the precision of the inferences we make based on the studies.</p>
<p>Imagine an impact evaluation with 10 people, where 5 are assigned to the treatment group and 5 to control. In one version of the experiment, the treatment is assigned to individuals - it is not cluster randomized. In another version of the experiment, the 5 individuals with black hair and the 5 individuals with some other color of hair are assigned to treatment as a group. This design has two clusters: ‘black hair’ and ‘other color’.</p>
<p>A simple application of the <em>n</em> choose <em>k</em> rule shows why this matters. In the first version, the randomization procedure allows for 252 different combinations of people as the treatment and control groups. However, in the second version, the randomization procedure assigns all the black-haired subjects either to treatment or to control, and thus only ever produces two ways of combining people to estimate an effect.</p>
<p>Throughout this guide, we will illustrate points using examples written in <code>R</code> code. You can copy and paste this into your own <code>R</code> program to see how it works.</p>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-2_27d2ab7222ebe80f15601521b527c821">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the sample average treatment effect (SATE)</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>treatment_effect     <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the individual ids (i)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>person               <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the cluster indicator (j)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>hair_color           <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"black"</span>,<span class="dv">5</span>),<span class="fu">rep</span>(<span class="st">"brown"</span>,<span class="dv">5</span>))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the control outcome (Y0)</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>outcome_if_untreated <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the treatment outcome (Y1)</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>outcome_if_treated   <span class="ot">&lt;-</span> outcome_if_untreated <span class="sc">+</span> treatment_effect</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Version 1 - Not cluster randomized</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate all possible non-clustered assignments of treatment (Z)</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>non_clustered_assignments <span class="ot">&lt;-</span> <span class="fu">combn</span>(<span class="at">x =</span> <span class="fu">unique</span>(person),<span class="at">m =</span> <span class="dv">5</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the treatment effect</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>treatment_effects_V1 <span class="ot">&lt;-</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>     <span class="fu">apply</span>(</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">X =</span> non_clustered_assignments,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>          <span class="at">MARGIN =</span> <span class="dv">2</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">FUN =</span> <span class="cf">function</span>(assignment) {</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>               treated_outcomes   <span class="ot">&lt;-</span> outcome_if_treated[person <span class="sc">%in%</span> assignment]</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>               untreated_outcomes <span class="ot">&lt;-</span> outcome_if_untreated[<span class="sc">!</span>person <span class="sc">%in%</span> assignment]</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>               <span class="fu">mean</span>(treated_outcomes) <span class="sc">-</span> <span class="fu">mean</span>(untreated_outcomes)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>     )</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the true standard error</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>standard_error_V1 <span class="ot">&lt;-</span> <span class="fu">sd</span>(treatment_effects_V1)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the histogram of all possible estimates of the treatment effect</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(treatment_effects_V1,<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="fl">2.5</span>),<span class="at">breaks =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="cluster-random_en_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-3_09174946898e1d76273a5aa6e8ce059b">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Version 2 - Cluster randomized</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate all possible assignments of treatment when clustering by hair color (Z)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>clustered_assignments     <span class="ot">&lt;-</span> <span class="fu">combn</span>(<span class="at">x =</span> <span class="fu">unique</span>(hair_color),<span class="at">m =</span> <span class="dv">1</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the treatment effect</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>treatment_effects_V2 <span class="ot">&lt;-</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">sapply</span>(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">X =</span> clustered_assignments,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">FUN =</span> <span class="cf">function</span>(assignment) {</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>               treated_outcomes   <span class="ot">&lt;-</span> outcome_if_treated[person <span class="sc">%in%</span> person[hair_color<span class="sc">==</span>assignment]]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>               untreated_outcomes <span class="ot">&lt;-</span> outcome_if_untreated[person <span class="sc">%in%</span> person[<span class="sc">!</span>hair_color<span class="sc">==</span>assignment]]</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>               <span class="fu">mean</span>(treated_outcomes) <span class="sc">-</span> <span class="fu">mean</span>(untreated_outcomes)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>     )</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the true standard error</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>standard_error_V2 <span class="ot">&lt;-</span> <span class="fu">sd</span>(treatment_effects_V2)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the histogram of all possible estimates of the treatment effect</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(treatment_effects_V2,<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="fl">2.5</span>),<span class="at">breaks =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="cluster-random_en_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As the histograms show, clustering provides a much ‘coarser’ view of the treatment effect. Irrespective of the number of times one randomizes the treatment and of the number of subjects one has, in a clustered randomization procedure the number of possible estimates of the treatment effect will be strictly determined by the number of clusters assigned to the different treatment conditions. This has important implications for the standard error of the estimator.</p>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the standard errors</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">round</span>(<span class="fu">data.frame</span>(standard_error_V1,standard_error_V2),<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">standard_error_V1</th>
<th style="text-align: right;">standard_error_V2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.52</td>
<td style="text-align: right;">1.13</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>While the sampling distribution for the non-clustered estimate of the treatment effect has a standard error of about .52, that of the clustered estimate is more than twice as large, at 1.13. Recall that the data going into both studies is identical, the only difference between the studies resides in the way that the treatment assignment mechanism reveals the information.</p>
<p>Related to this issue of information is the question of how much units in our study vary within and between clusters. Two cluster randomized studies with <span class="math inline">\(J=10\)</span> villages and <span class="math inline">\(n_j=100\)</span> people per village may have different information about the treatment effect on individuals if, in one study, differences <em>between</em> villages are much greater than the differences in outcomes <em>within</em> them. If, say, all of the individuals in any village acted exactly the same but different villages showed different outcomes, then we would have on the order of 10 pieces of information: all of the information about causal effects in that study would be at the village level. Alternatively, if the individuals within a village acted more or less independently of each other, then we would have on the order of 10 <span class="math inline">\(\times\)</span> 100=1000 pieces of information.</p>
<p>We can formalize the idea that the highly dependent clusters provide less information than the highly independent clusters with the <strong>intracluster correlation coefficient</strong>. For a given variable, <span class="math inline">\(y\)</span>, units <span class="math inline">\(i\)</span> and clusters <span class="math inline">\(j\)</span>, we can write the intracluster correlation coefficient as follows:</p>
<p><span class="math display">\[ \text{ICC} \equiv \frac{\text{variance between clusters in } y}{\text{total variance in } y} \equiv \frac{\sigma_j^2}{\sigma_j^2 + \sigma_i^2} \]</span></p>
<p>where <span class="math inline">\(\sigma_i^2\)</span> is the variance between units in the population and <span class="math inline">\(\sigma_j^2\)</span> is the variance between outcomes defined at the cluster level. <span class="citation" data-cites="kish1965survey">Kish (<a href="#ref-kish1965survey" role="doc-biblioref">1965</a>)</span> uses this description of dependence to define his idea of the “effective N” of a study (in the sample survey context, where samples may be clustered):</p>
<p><span class="math display">\[\text{effective N}=\frac{N}{1+(n_j -1)\text{ICC}}=\frac{Jn}{1+(n-1)\text{ICC}},\]</span></p>
<p>where the second term follows if all of the clusters are the same size (<span class="math inline">\(n_1 \ldots n_J \equiv n\)</span>).</p>
<p>If 200 observations arose from 10 clusters with 20 individuals within each cluster, where ICC = .5, such that 50% of the variation could be attributed to cluster-to-cluster differences (and not to differences within a cluster), Kish’s formula would suggest that we have an effective sample size of about 19 observations, instead of 200.</p>
<p>As the foregoing discussion suggests, clustering reduces information most when it a) greatly restricts the number of ways in which subjects can be assigned to treatment and control groups, and b) produces units whose outcomes are strongly related to the cluster they are a member of (i.e.&nbsp;when it increases the ICC).</p>
</section>
<section id="what-to-do-about-information-reduction" class="level1">
<h1>3 What to do about information reduction</h1>
<p>One way to limit the extent to which clustering reduces the information contained in our design would be to form clusters in such a way that the intracluster correlation is low. For example, if we were able to form clusters randomly, there would be no systematic relationship between units within a cluster. Hence, using cluster random assignment to assign these randomly formed clusters to experimental conditions would not result in any information reduction. Yet, opportunities to create clusters are typically rare. In most cases, we have to rely on naturally formed clusters (e.g., villages, classrooms, cities). In most scenarios that involve clustered assignment, we hence will have to make sure that our estimates of uncertainty about treatment effects correctly reflect the resulting information loss from clustering.</p>
<p>In order to characterize our uncertainty about treatment effects, we typically want to calculate a standard error: an estimate of how much our treatment effect estimates <em>would</em> vary, were we able to repeat the experiment a very large number of times and, for each repetition, observe units in their resulting treated or untreated state.</p>
<p>However, we are never able to observe the true standard error of an estimator, and therefore must use statistical procedures to infer this unknown quantity. Conventional methods for calculating standard errors do not take into account clustering. Thus, in order to avoid over-confidence in experimental findings, we need to modify the way in which we calculate uncertainty estimates.</p>
<p>In this section we limit our attention to so-called ‘design-based’ approaches to calculating the standard error. In the design-based approach we simulate repetitions of the experiment to derive and check ways of characterizing the variance of the estimate of the treatment effect, accounting for clustered randomization. We contrast these with ‘model-based’ approaches further on in the guide. In the model-based approach we state that the outcomes were generated according to a probability model and that the cluster-level relationships also follow a probability model.</p>
<p>To begin, we will create a function which simulates a cluster randomized experiment with fixed intracluster correlation, and use it to simulate some data from a simple cluster-randomized design.</p>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-5_9fa138a0cb87675dc0ccffe16497f0e8">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>make_clustered_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">J =</span> <span class="dv">10</span>, <span class="at">n =</span> <span class="dv">100</span>, <span class="at">treatment_effect =</span> .<span class="dv">25</span>, <span class="at">ICC =</span> .<span class="dv">1</span>){</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>     <span class="do">## Inspired by Mathieu et al, 2012, Journal of Applied Psychology</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>     <span class="cf">if</span> (J <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">|</span> n <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">!=</span><span class="dv">0</span>) {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>          <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">"Number of clusters (J) and size of clusters (n) must be even."</span>))</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>     Y0_j         <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(J,<span class="dv">0</span>,<span class="at">sd =</span> (<span class="dv">1</span> <span class="sc">+</span> treatment_effect) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(ICC))</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>     fake_data    <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n,<span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>J)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>     fake_data<span class="sc">$</span>Y0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n <span class="sc">*</span> J,<span class="dv">0</span>,<span class="at">sd =</span> (<span class="dv">1</span> <span class="sc">+</span> treatment_effect) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> ICC)) <span class="sc">+</span> Y0_j[fake_data<span class="sc">$</span>j]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>     fake_data<span class="sc">$</span>Y1 <span class="ot">&lt;-</span> <span class="fu">with</span>(fake_data,<span class="fu">mean</span>(Y0) <span class="sc">+</span> treatment_effect <span class="sc">+</span> (Y0 <span class="sc">-</span> <span class="fu">mean</span>(Y0)) <span class="sc">*</span> (<span class="dv">2</span> <span class="sc">/</span> <span class="dv">3</span>))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>     fake_data<span class="sc">$</span>Z  <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(fake_data<span class="sc">$</span>j <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>J,J <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>     fake_data<span class="sc">$</span>Y  <span class="ot">&lt;-</span> <span class="fu">with</span>(fake_data, Z <span class="sc">*</span> Y1 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> Z) <span class="sc">*</span> Y0)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>     <span class="fu">return</span>(fake_data)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>pretend_data <span class="ot">&lt;-</span> <span class="fu">make_clustered_data</span>(<span class="at">J =</span> <span class="dv">10</span>,<span class="at">n =</span> <span class="dv">100</span>,<span class="at">treatment_effect =</span> .<span class="dv">25</span>,<span class="at">ICC =</span> .<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because we have created the data ourselves, we can calculate the true standard error of our estimator. We firstly generate the true sampling distribution by simulating every possible permutation of the treatment and calculating the estimate each time. The standard deviation of this distribution is the standard error of the estimator.</p>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-6_c10f1662f2662689c454c7df965d0508">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the number of clusters</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>J <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(pretend_data<span class="sc">$</span>j))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate all possible ways of combining clusters into a treatment group</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>all_treatment_groups <span class="ot">&lt;-</span> <span class="fu">with</span>(pretend_data,<span class="fu">combn</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span>J,<span class="at">m =</span> J<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a function for estimating the effect</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>clustered_ATE <span class="ot">&lt;-</span> <span class="cf">function</span>(j,Y1,Y0,treated_clusters) {</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>     Z_sim    <span class="ot">&lt;-</span> (j <span class="sc">%in%</span> treated_clusters)<span class="sc">*</span><span class="dv">1</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>     Y        <span class="ot">&lt;-</span> Z_sim <span class="sc">*</span> Y1 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> Z_sim) <span class="sc">*</span> Y0</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>     estimate <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y[Z_sim <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">-</span> <span class="fu">mean</span>(Y[Z_sim <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>     <span class="fu">return</span>(estimate)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function through all possible treatment assignments</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>cluster_results <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> all_treatment_groups, <span class="at">MARGIN =</span> <span class="dv">2</span>,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                         <span class="at">FUN =</span> clustered_ATE,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                         <span class="at">j  =</span> pretend_data<span class="sc">$</span>j,<span class="at">Y1 =</span> pretend_data<span class="sc">$</span>Y1,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y0 =</span> pretend_data<span class="sc">$</span>Y0</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>true_SE <span class="ot">&lt;-</span> <span class="fu">sd</span>(cluster_results)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>true_SE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2567029</code></pre>
</div>
</div>
<p>This gives a standard error of 0.26. We can compare the true standard error to two other kinds of standard error commonly employed. The first ignores clustering and assumes that treatment effect estimates are identically and independently distributed according to a normal distribution. We will refer to this as the I.I.D. standard error. To take clustering into account, we can use the following formula for the standard error:</p>
<p><span class="math display">\[\text{Var}_\text{clustered}(\hat{\tau})=\frac{\sigma^2}{\sum_{j=1}^J \sum_{i=1}^{n_j} (Z_{ij}-\bar{Z})^2} (1-(n-1)\rho)\]</span></p>
<p>where <span class="math inline">\(\sigma^2=\sum_{j=1}^J \sum_{i=1}^{n_j} (Y_{ij} - \bar{Y}_{ij})^2\)</span> (following <span class="citation" data-cites="arceneaux2009modeling">Arceneaux and Nickerson (<a href="#ref-arceneaux2009modeling" role="doc-biblioref">2009</a>)</span> ). This adjustment to the IID standard error is commonly known as the “Robust Clustered Standard Error” or RCSE.</p>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-7_03ea9d601ed31ab4981f6a5dc3b9a5de">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ATE_estimate <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> Z,<span class="at">data =</span> pretend_data)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>IID_SE <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">return</span>(<span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(model)))[[<span class="st">"Z"</span>]])</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>RCSE <span class="ot">&lt;-</span> <span class="cf">function</span>(model, cluster,<span class="at">return_cov =</span> <span class="cn">FALSE</span>){</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(sandwich)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(lmtest)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(cluster))</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">length</span>(cluster)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> model<span class="sc">$</span>rank</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  dfc <span class="ot">&lt;-</span> (M<span class="sc">/</span>(M <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">*</span> ((N <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">/</span>(N <span class="sc">-</span> K))</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  uj <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">estfun</span>(model), <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">tapply</span>(x, cluster, sum))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  rcse.cov <span class="ot">&lt;-</span> dfc <span class="sc">*</span> <span class="fu">sandwich</span>(model, <span class="at">meat =</span> <span class="fu">crossprod</span>(uj)<span class="sc">/</span>N)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  rcse.se <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">coeftest</span>(model, rcse.cov))</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(return_cov){</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(rcse.cov)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(rcse.se)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>IID_SE_estimate <span class="ot">&lt;-</span> <span class="fu">IID_SE</span>(<span class="at">model =</span> ATE_estimate)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>RCSE_estimate   <span class="ot">&lt;-</span> <span class="fu">RCSE</span>(<span class="at">model =</span> ATE_estimate,<span class="at">cluster =</span> pretend_data<span class="sc">$</span>j)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">round</span>(</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>     <span class="at">true_SE         =</span> true_SE,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>     <span class="at">IID_SE_estimate =</span> IID_SE_estimate,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">RCSE_estimate   =</span> RCSE_estimate[<span class="st">"Z"</span>, <span class="st">"Std. Error"</span>]</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">true_SE</th>
<th style="text-align: right;">IID_SE_estimate</th>
<th style="text-align: right;">RCSE_estimate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.26</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>When we ignore the clustered-assignment, the standard error is too small: we are over-confident about the amount of information provided to us by the experiment. The RCSE is slightly more conservative than the true standard error in this instance, but is very close. The discrepancy is likely because the RCSE is not a good approximation of the true standard error when the number of clusters is as small as it is here. To illustrate the point further, we can compare a simulation of the true standard error generated through random permutations of the treatment to the IID and RC standard errors.</p>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-8_723e5fa648267da435878a2f04d7572f">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>compare_SEs <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>     simulated_SE <span class="ot">&lt;-</span> <span class="fu">sd</span>(<span class="fu">replicate</span>(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>          <span class="dv">5000</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>          <span class="fu">clustered_ATE</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">j =</span> data<span class="sc">$</span>j,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">Y1 =</span> data<span class="sc">$</span>Y1,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">Y0 =</span> data<span class="sc">$</span>Y0,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">treated_clusters =</span> <span class="fu">sample</span>(<span class="fu">unique</span>(data<span class="sc">$</span>j),<span class="fu">length</span>(<span class="fu">unique</span>(data<span class="sc">$</span>j))<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>     ATE_estimate <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> Z,data)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>     IID_SE_estimate <span class="ot">&lt;-</span> <span class="fu">IID_SE</span>(<span class="at">model =</span> ATE_estimate)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>     RCSE_estimate <span class="ot">&lt;-</span> <span class="fu">RCSE</span>(<span class="at">model =</span> ATE_estimate,<span class="at">cluster =</span> data<span class="sc">$</span>j)[<span class="st">"Z"</span>, <span class="st">"Std. Error"</span>]</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>     <span class="fu">return</span>(<span class="fu">round</span>(<span class="fu">c</span>(</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">simulated_SE =</span> simulated_SE,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">IID_SE =</span> IID_SE_estimate,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">RCSE =</span> RCSE_estimate</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>     ),<span class="dv">3</span>))</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>J_4_clusters    <span class="ot">&lt;-</span> <span class="fu">make_clustered_data</span>(<span class="at">J =</span> <span class="dv">4</span>)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>J_10_clusters   <span class="ot">&lt;-</span> <span class="fu">make_clustered_data</span>(<span class="at">J =</span> <span class="dv">10</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>J_30_clusters   <span class="ot">&lt;-</span> <span class="fu">make_clustered_data</span>(<span class="at">J =</span> <span class="dv">30</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>J_100_clusters  <span class="ot">&lt;-</span> <span class="fu">make_clustered_data</span>(<span class="at">J =</span> <span class="dv">100</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>J_1000_clusters <span class="ot">&lt;-</span> <span class="fu">make_clustered_data</span>(<span class="at">J =</span> <span class="dv">1000</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">rbind</span>(</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">J =</span> <span class="dv">4</span>,<span class="fu">compare_SEs</span>(J_4_clusters)),</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">J =</span> <span class="dv">30</span>,<span class="fu">compare_SEs</span>(J_30_clusters)),</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">J =</span> <span class="dv">100</span>,<span class="fu">compare_SEs</span>(J_100_clusters)),</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">J =</span> <span class="dv">1000</span>,<span class="fu">compare_SEs</span>(J_1000_clusters))</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">J</th>
<th style="text-align: right;">simulated_SE</th>
<th style="text-align: right;">IID_SE</th>
<th style="text-align: right;">RCSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">0.270</td>
<td style="text-align: right;">0.127</td>
<td style="text-align: right;">0.260</td>
</tr>
<tr class="even">
<td style="text-align: right;">30</td>
<td style="text-align: right;">0.161</td>
<td style="text-align: right;">0.047</td>
<td style="text-align: right;">0.146</td>
</tr>
<tr class="odd">
<td style="text-align: right;">100</td>
<td style="text-align: right;">0.085</td>
<td style="text-align: right;">0.027</td>
<td style="text-align: right;">0.088</td>
</tr>
<tr class="even">
<td style="text-align: right;">1000</td>
<td style="text-align: right;">0.027</td>
<td style="text-align: right;">0.008</td>
<td style="text-align: right;">0.027</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As these simple examples illustrate, the clustered estimate of the standard error (RCSE) gets closer to the truth (the simulated standard error) as the number of clusters increases. Meanwhile, the standard error ignoring clustering (assuming IID) tends to be smaller than either of the other standard errors. The smaller the estimate of the standard error is, the more precise the estimates seem to us, and the more likely we will find results that appear ‘statistically significant’. This is problematic: in this case, the IID standard error is leads us to be over confident in our results because it ignores intra-cluster correlation, the extent to which differences between units can be attributed to the cluster they are a member of. If we estimate standard errors using techniques that understate our uncertainty, we are more likely to falsely reject null hypotheses when we should not.</p>
<p>Another way to approach the problems that clustering introduces into the calculation of standard errors is to analyze the data at the level of the cluster. In this approach, we take averages or sums of the outcomes within the clusters, and then treat the study as though it only took place at the level of the cluster. <span class="citation" data-cites="hansen2008covariate">Hansen and Bowers (<a href="#ref-hansen2008covariate" role="doc-biblioref">2008</a>)</span> show that we can characterize the distribution of the difference of means using what we know about the distribution of the <em>sum</em> of the outcome in the treatment group, which varies from one assignment of treatment to another.</p>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-9_726a55ad7a7a74a72aaa75cd5da6dbd4">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate the unit-level data to the cluster level</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Sum outcome to cluster level</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>Yj <span class="ot">&lt;-</span> <span class="fu">tapply</span>(pretend_data<span class="sc">$</span>Y,pretend_data<span class="sc">$</span>j,sum)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate assignment indicator to cluster level</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>Zj <span class="ot">&lt;-</span> <span class="fu">tapply</span>(pretend_data<span class="sc">$</span>Z,pretend_data<span class="sc">$</span>j,unique)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate unique cluster size</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>n_j <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">as.vector</span>(<span class="fu">table</span>(pretend_data<span class="sc">$</span>j)))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate total sample size (our units are now clusters)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(Zj)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate cluster id</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>j <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>N</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate number of clusters treated</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>J_treated <span class="ot">&lt;-</span> <span class="fu">sum</span>(Zj)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a function for the cluster-level difference in means estimator (See Hansen &amp; Bowers 2008)</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>cluster_difference <span class="ot">&lt;-</span> <span class="cf">function</span>(Yj,Zj,n_j,J_treated,N){</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>     ones <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(Zj))</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>     ATE_estimate <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(Zj,Yj)<span class="sc">*</span>(N<span class="sc">/</span>(n_j<span class="sc">*</span>J_treated<span class="sc">*</span>(N<span class="sc">-</span>J_treated))) <span class="sc">-</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>          <span class="fu">crossprod</span>(ones,Yj)<span class="sc">/</span>(n_j<span class="sc">*</span>(N<span class="sc">-</span>J_treated))</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>     <span class="fu">return</span>(ATE_estimate)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Given equal sized clusters and no blocking, this is identical to the</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># unit-level difference in means</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>ATEs <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(<span class="fu">data.frame</span>(</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_level_ATE =</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>               <span class="fu">cluster_difference</span>(Yj,Zj,n_j,J_treated,N),</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>          <span class="at">unit_level_ATE =</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">with</span>(pretend_data, <span class="fu">mean</span>(Y[Z <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">-</span> <span class="fu">mean</span>(Y[Z <span class="sc">==</span> <span class="dv">0</span>]))</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">data.frame</span>(ATEs),<span class="at">align =</span> <span class="st">"c"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: center;">ATEs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">cluster_level_ATE</td>
<td style="text-align: center;">0.3417229</td>
</tr>
<tr class="even">
<td style="text-align: left;">unit_level_ATE</td>
<td style="text-align: center;">0.3417229</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In order to characterize uncertainty about the cluster-level ATE, we can exploit the fact that the only random element of the estimator is now the cross-product between the cluster-level assignment vector and the cluster-level outcome, <span class="math inline">\(\mathbf{Z}^\top\mathbf{Y}\)</span>, scaled by some constant. We can estimate the variance of this random component through permutation of the assignment vector or through an approximation of the variance, assuming that the sampling distribution follows a normal distribution.</p>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-10_8316349bb154f8195e23d2586c94083b">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Approximating variance using normality assumptions</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>normal_sampling_variance <span class="ot">&lt;-</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>     (N<span class="sc">/</span>(n_j<span class="sc">*</span>J_treated<span class="sc">*</span>(N<span class="sc">-</span>J_treated)))<span class="sc">*</span>(<span class="fu">var</span>(Yj)<span class="sc">/</span>n_j)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Approximating variance using permutations</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>sampling_distribution <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">10000</span>,<span class="fu">cluster_difference</span>(Yj,<span class="fu">sample</span>(Zj),n_j,J_treated,N))</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>ses <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sampling_variance =</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(normal_sampling_variance), <span class="fu">sd</span>(sampling_distribution)),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_values =</span> <span class="fu">c</span>(</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">pnorm</span>(<span class="fu">abs</span>(ATEs[<span class="dv">1</span>]) <span class="sc">/</span> <span class="fu">sqrt</span>(normal_sampling_variance), <span class="at">mean =</span> <span class="dv">0</span>)),</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                               <span class="dv">2</span><span class="sc">*</span><span class="fu">min</span>(<span class="fu">mean</span>(sampling_distribution<span class="sc">&gt;=</span>ATEs[<span class="dv">1</span>]),<span class="fu">mean</span>(sampling_distribution<span class="sc">&lt;=</span>ATEs[<span class="dv">1</span>]))</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ses) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Assuming Normality"</span>,<span class="st">"Permutations"</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(ses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">sampling_variance</th>
<th style="text-align: right;">p_values</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Assuming Normality</td>
<td style="text-align: right;">0.2848150</td>
<td style="text-align: right;">0.2302145</td>
</tr>
<tr class="even">
<td style="text-align: left;">Permutations</td>
<td style="text-align: right;">0.2825801</td>
<td style="text-align: right;">0.2792000</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This cluster-level approach has the advantage of correctly characterizing uncertainty about effects when randomization is clustered, without having to use the RCSE standard errors for the unit-level estimates, which are overly permissive for small N. Indeed, the false positive rate of tests based on RCSE standard errors tend to be incorrect when the number of clusters is small, leading to over-confidence. As we shall see below, however, when the number of clusters is very small (<span class="math inline">\(J=4\)</span>) the cluster-level approach is overly conservative, rejecting the null with a probability of 1. Another drawback of the cluster-level approach is that it does not allow for the estimation of unit-level quantities of interest, such as heterogeneous treatment effects.</p>
</section>
<section id="why-clustering-can-matter-ii-different-cluster-sizes-and-bias" class="level1">
<h1>4 Why clustering can matter II: different cluster sizes and bias</h1>
<p>When clusters are of different sizes, this can pose a unique class of problems related to the estimation of the treatment effect. Especially when the size of the cluster is in some way related to the potential outcomes of the units within it many conventional estimators of the sample average treatment effect (SATE) can be biased.</p>
<p>To fix ideas, imagine an intervention targeted at firms of different sizes, which seeks to increase worker productivity. Due to economies of scale, the productivity of employees in big firms is increased much more proportional to that of employees in smaller firms. Imagine that the experiment includes 20 firms ranging in size from one-person entrepreneurs to large outfits with over 500 employees. Half of the firms are assigned to the treatment, and the other half are assigned to control. Outcomes are defined at the employee level.</p>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-11_c30bdb74f9a61287c3300598d40cacdb">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1000</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of firms</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>J <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Employees per firm</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>n_j <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">2</span><span class="sc">^</span>(<span class="dv">0</span><span class="sc">:</span>(J<span class="sc">/</span><span class="dv">2-1</span>)),<span class="fu">rep</span>(<span class="dv">2</span>,J<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Total number of employees</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">sum</span>(n_j)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2046</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Unique employee (unit) ID</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>N</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Unique firm (cluster) ID</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>j <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(n_j),n_j)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Firm specific treatment effects</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>cluster_ATE <span class="ot">&lt;-</span> n_j<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="dv">10000</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Untreated productivity</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Treated productivity</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> Y0 <span class="sc">+</span> cluster_ATE[j]</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co"># True sample average treatment effect</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>(true_SATE <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y1<span class="sc">-</span>Y0))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 14.9943</code></pre>
</div>
</div>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-12_04e80e0de4110b88309021c9d9ac166c">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation between firm size and effect size</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(n_j,cluster_ATE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.961843</code></pre>
</div>
</div>
<p>As we see, there is high correlation in the treatment effect and cluster size. Now let us simulate 1000 analyses of this experiment, permuting the treatment assignment vector each time, and taking the unweighted difference in means as an estimate of the sample average treatment effect.</p>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-13_679504259cd7e456daf0bd1a013744a1">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Unweighted SATE</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>SATE_estimate_no_weights <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Clustered random assignment of half of the firms</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>     Z <span class="ot">&lt;-</span> (j <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>J,J<span class="sc">/</span><span class="dv">2</span>))<span class="sc">*</span><span class="dv">1</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Reveal outcomes</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>     Y <span class="ot">&lt;-</span> Z<span class="sc">*</span>Y1 <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>Z)<span class="sc">*</span>Y0</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Estimate SATE</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>     SATE_estimate_no_weights[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y[Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(Y[Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate histogram of estimated effects</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(SATE_estimate_no_weights,<span class="at">xlim =</span> <span class="fu">c</span>(true_SATE<span class="dv">-2</span>,true_SATE<span class="sc">+</span><span class="dv">2</span>),<span class="at">breaks =</span> <span class="dv">100</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the expected estimate of the SATE using this estimator</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">mean</span>(SATE_estimate_no_weights),<span class="at">col=</span><span class="st">"blue"</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co"># And add the true SATE</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>true_SATE,<span class="at">col=</span><span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="cluster-random_en_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The histogram shows the sampling distribution of the estimator, with the true SATE in red and the unweighted estimate thereof in blue. The estimator is biased: in expectation, we do not recover the true SATE, instead underestimating it. Intuitively, one might correctly expect that the problem is related to the relative weight of the clusters in the calculation of the treatment effect. However, in this situation, taking the difference in the weighted average of the outcome among treated and control clusters is not enough to provide an unbiased estimator (see the code below).</p>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-14_2d6bb4f4992978af0ca5167217fa0798">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Weighted cluster-averages</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>SATE_estimate_weighted <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Define the clusters put into treatment</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>     treated_clusters <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>J,J<span class="sc">/</span><span class="dv">2</span>,<span class="at">replace =</span> F)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Generate unit-level assignment vector</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>     Z <span class="ot">&lt;-</span> (j <span class="sc">%in%</span> treated_clusters)<span class="sc">*</span><span class="dv">1</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Reveal outcomes</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>     Y <span class="ot">&lt;-</span> Z<span class="sc">*</span>Y1 <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>Z)<span class="sc">*</span>Y0</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Calculate the cluster weights</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>     treated_weights <span class="ot">&lt;-</span> n_j[<span class="dv">1</span><span class="sc">:</span>J<span class="sc">%in%</span>treated_clusters]<span class="sc">/</span><span class="fu">sum</span>(n_j[<span class="dv">1</span><span class="sc">:</span>J<span class="sc">%in%</span>treated_clusters])</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>     control_weights <span class="ot">&lt;-</span> n_j[<span class="sc">!</span><span class="dv">1</span><span class="sc">:</span>J<span class="sc">%in%</span>treated_clusters]<span class="sc">/</span><span class="fu">sum</span>(n_j[<span class="sc">!</span><span class="dv">1</span><span class="sc">:</span>J<span class="sc">%in%</span>treated_clusters])</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Calculate the means of each cluster</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>     treated_means <span class="ot">&lt;-</span> <span class="fu">tapply</span>(Y,j,mean)[<span class="dv">1</span><span class="sc">:</span>J<span class="sc">%in%</span>treated_clusters]</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>     control_means <span class="ot">&lt;-</span> <span class="fu">tapply</span>(Y,j,mean)[<span class="sc">!</span><span class="dv">1</span><span class="sc">:</span>J<span class="sc">%in%</span>treated_clusters]</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Calculate the cluster-weighted estimate of the SATE</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>     SATE_estimate_weighted[i] <span class="ot">&lt;-</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">weighted.mean</span>(treated_means,treated_weights) <span class="sc">-</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>          <span class="fu">weighted.mean</span>(control_means,control_weights)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate histogram of estimated effects</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(SATE_estimate_weighted,<span class="at">xlim =</span> <span class="fu">c</span>(true_SATE<span class="dv">-2</span>,true_SATE<span class="sc">+</span><span class="dv">2</span>),<span class="at">breaks =</span> <span class="dv">100</span>)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the expected estimate of the unweighted SATE</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">mean</span>(SATE_estimate_no_weights),<span class="at">col=</span><span class="st">"blue"</span>)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the expected estimate of the weighted SATE</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">mean</span>(SATE_estimate_weighted),<span class="at">col=</span><span class="st">"green"</span>)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="co"># And add the true SATE</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>true_SATE,<span class="at">col=</span><span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="cluster-random_en_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The histogram shows the sampling distribution of the weighted estimator, with the true SATE in red and the unweighted estimate in blue, and the weighted estimate in green. In expectation, the weighted version of the estimator in fact gives the same estimate of the SATE as the non-weighted version. What is the nature of the bias?</p>
<p>Instead of assigning treatment to half of the clusters and comparing outcomes at the level of the ‘treatment’ and ‘control’ groups, imagine that we paired each cluster with one other cluster, and assigned one to treatment within each pair. Our estimate of the treatment effect is then the aggregate of the pair-level estimates. This is analogous to the complete random assignment procedure employed above, in which <span class="math inline">\(J/2\)</span> firms were assigned to treatment. Now, we will instead refer to the <span class="math inline">\(k\)</span>’th of the <span class="math inline">\(m\)</span> pairs, where <span class="math inline">\(2m = J\)</span>.</p>
<p>Given this setup, <span class="citation" data-cites="imai2009essential">Imai, King, and Nall (<a href="#ref-imai2009essential" role="doc-biblioref">2009</a>)</span> give the following formal definition of the bias in the cluster-weighted difference-in-means estimator</p>
<p><span class="math display">\[\frac{1}{n}
\sum^m_{k = 1}
\sum^2_{l = 1}
\left[
\left(
\frac{n_{1k} + n_{2k}}{{2} - n_{lk}}
\right)
\times
\sum^{n_{lk}}_{i = 1}
\frac{Y_{ilk}(1) - Y_{ilk}(0)}{n_{lk}}
\right],\]</span></p>
<p>where <span class="math inline">\(l = 1,2\)</span> indexes the clusters within each pair. Thus, <span class="math inline">\(n_{1k}\)</span> refers to the number of units in the first of the <span class="math inline">\(k\)</span>’th pair of clusters.</p>
<p>This expression indicates that bias from unequal cluster sizes arises if and only if two conditions are met. Firstly, the sizes of at least one pair of clusters must be unequal: when <span class="math inline">\(n_{1k}=n_{2k}\)</span> for all <span class="math inline">\(k\)</span>, the bias term is reduced to 0. Secondly, the weighted effect sizes of at least one pair of clusters must be unequal: when <span class="math inline">\(\sum_{i = 1}^{n_{1k}}(Y_{i1k}(1)-Y_{i1k}(0))/n_{1k} = \sum_{i = 1}^{n_{2k}}(Y_{i2k}(1)-Y_{i2k}(0))/n_{2k}\)</span> for all <span class="math inline">\(k\)</span>, the bias is also reduced to 0.</p>
</section>
<section id="what-to-do-about-different-cluster-sizes" class="level1">
<h1>5 What to do about different cluster sizes</h1>
<p>Two other approaches work to alleviate this problem of bias from the correlation of cluster size and treatment effect: (1) condition on cluster size directly and (2) use the Horvitz-Thompson estimator. This <a href="https://declaredesign.org/blog/bias-cluster-randomized-trials.html">DeclareDesign Blog Post</a> discusses both options. Here we demonstrate a pairing approach to conditioning on cluster-size given the example data that we generated above.</p>
<p>As the above expression suggests, in order to reduce the bias from unequal cluster sizes to almost 0, it is sufficient to put clusters into pairs that either are of equal size or have almost identical potential outcomes.</p>
<p>We demonstrate this approach below using the same data as we examined in the example of a hypothetical firm-randomized employee productivity experiment.</p>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-15_28b9ae56632127c031e012a11f620830">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a function that matches pairs based on size</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>pair_sizes <span class="ot">&lt;-</span> <span class="cf">function</span>(j,n_j){</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Find all of the unique sizes</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>     unique_sizes <span class="ot">&lt;-</span> <span class="fu">unique</span>(n_j)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Find the number of unique sizes</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>     N_unique_sizes <span class="ot">&lt;-</span> <span class="fu">length</span>(unique_sizes)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Generate a list of candidates for pairing at each cluster size</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  possible_pairs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(unique_sizes, <span class="cf">function</span>(size) {</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">which</span>(n_j <span class="sc">==</span> size)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Find the number of all possible pairs (m)</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>     m_pairs <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unlist</span>(possible_pairs))<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Generate a vector with unique pair-level identifiers</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>     pair_indicator <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>m_pairs,<span class="fu">rep</span>(<span class="dv">2</span>,m_pairs))</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Randomly assign units of the same cluster size into pairs</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>     pair_assignment <span class="ot">&lt;-</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>          <span class="fu">unlist</span>(<span class="fu">lapply</span>(</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>               possible_pairs,</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>               <span class="cf">function</span>(pair_list){</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sample</span>(pair_indicator[<span class="fu">unlist</span>(possible_pairs) <span class="sc">%in%</span> pair_list])</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Generate a vector indicating the k'th pair for each i unit</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>     pair_assignment <span class="ot">&lt;-</span> pair_assignment[<span class="fu">match</span>(<span class="at">x =</span> j,<span class="at">table =</span> <span class="fu">unlist</span>(possible_pairs))]</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>     <span class="fu">return</span>(pair_assignment)</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>pair_indicator <span class="ot">&lt;-</span> <span class="fu">pair_sizes</span>(<span class="at">j =</span> j , <span class="at">n_j =</span> n_j)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>SATE_estimate_paired <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Now loop through the vector of paired assignments</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>     pair_ATEs <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">unique</span>(pair_indicator),<span class="cf">function</span>(pair){</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>          <span class="co"># For each pair, randomly assign one to treatment</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>          Z <span class="ot">&lt;-</span> j[pair_indicator<span class="sc">==</span>pair] <span class="sc">%in%</span> <span class="fu">sample</span>(j[pair_indicator<span class="sc">==</span>pair],<span class="dv">1</span>)<span class="sc">*</span><span class="dv">1</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Reveal the potential outcomes of the pair</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>          Y <span class="ot">&lt;-</span> Z<span class="sc">*</span>Y1[pair_indicator<span class="sc">==</span>pair] <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>Z)<span class="sc">*</span>Y0[pair_indicator<span class="sc">==</span>pair]</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>          clust_weight <span class="ot">&lt;-</span> <span class="fu">length</span>(j[pair_indicator<span class="sc">==</span>pair])<span class="sc">/</span>N</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>          clust_ATE <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y[Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(Y[Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="fu">c</span>(<span class="at">weight =</span> clust_weight, <span class="at">ATE =</span> clust_ATE))</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>     })</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>     SATE_estimate_paired[i] <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(<span class="at">x =</span> pair_ATEs[<span class="st">"ATE"</span>,],<span class="at">w =</span> pair_ATEs[<span class="st">"weight"</span>,])</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate histogram of estimated effects</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(SATE_estimate_paired,<span class="at">xlim =</span> <span class="fu">c</span>(true_SATE<span class="dv">-2</span>,true_SATE<span class="sc">+</span><span class="dv">2</span>),<span class="at">breaks =</span> <span class="dv">100</span>)</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the expected estimate of the paired SATE</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">mean</span>(SATE_estimate_paired),<span class="at">col=</span><span class="st">"purple"</span>)</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="co"># And add the true SATE</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>true_SATE,<span class="at">col=</span><span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="cluster-random_en_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-16_0d04512e22bb4b4fdb9da984453677ae">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The paired estimator is much closer to the true SATE</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">round</span>(<span class="fu">data.frame</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">true_SATE =</span> true_SATE,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">paired_SATE =</span> <span class="fu">mean</span>(SATE_estimate_paired),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">weighted_SATE =</span> <span class="fu">mean</span>(SATE_estimate_weighted),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">unweighted_SATE =</span> <span class="fu">mean</span>(SATE_estimate_no_weights)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>),<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">true_SATE</th>
<th style="text-align: right;">paired_SATE</th>
<th style="text-align: right;">weighted_SATE</th>
<th style="text-align: right;">unweighted_SATE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">14.99</td>
<td style="text-align: right;">14.99</td>
<td style="text-align: right;">13.45</td>
<td style="text-align: right;">13.45</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In spite of unequal cluster sizes, the bias is completely eliminated by this technique: in expectation, the paired estimator recovers the true Sample Average Treatment Effect, whereas the cluster-weighted and non-weighted difference-in-means estimators are biased.</p>
<p>Note also that the variance in the sampling distribution is much lower for the pair-matched estimator, giving rise to much more precise estimates. Thus, pair-matching not only promises to reduce bias, but can also greatly mitigate the problem of information reduction that clustering induces.</p>
<p>Such pre-randomization pair matching, however, does impose some constraints on the study, some of which may be difficult to meet in practice. For example, it may be difficult or even impossible to find perfectly-matched pairs for every cluster size, especially when there are multiple treatments (such that, instead of pairs, treatment is randomized over triplets or quadruplets). In such cases, researchers may adopt several other solutions, such as creating pairs by matching on observed covariates prior to the randomization, whereby, for example, the within-pair similarity of observed covariates is maximized. <span class="citation" data-cites="imai2009essential">Imai, King, and Nall (<a href="#ref-imai2009essential" role="doc-biblioref">2009</a>)</span> recommend a mixture model for post-randomization pair-matched estimation, and spell out some of the assumptions that must be made for such estimates to be valid. And this <a href="https://declaredesign.org/blog/bias-cluster-randomized-trials.html">DeclareDesign Blog Post</a> demonstrates conditioning on cluster-size without strict pairing.</p>
</section>
<section id="why-clustering-can-matter-iii-within-cluster-spillovers" class="level1">
<h1>6 Why clustering can matter III: within-cluster spillovers</h1>
<p>In many, or most experiments, we would like to estimate the average causal effect of the treatment within a population or a sample. Denoting <span class="math inline">\(Y_{z_i}\)</span> the outcome <span class="math inline">\(Y\)</span> of unit <span class="math inline">\(i\)</span> when assigned to the treatment status <span class="math inline">\(z_i \in \{1,0\}\)</span>, we can define this quantity – the ATE (Average Treatment Effect) – as the expected value of the difference between the sample when assigned to treatment, <span class="math inline">\(Y_1\)</span> and the sample when assigned to control <span class="math inline">\(Y_0\)</span>: <span class="math inline">\(E[Y_1 - Y_0]\)</span>.</p>
<p>However, it may be the case that a unit’s outcome depends on the treatment status <span class="math inline">\(z_j\)</span> of another unit, <span class="math inline">\(j\)</span>, inside the same cluster. In that case, we denote potential outcomes <span class="math inline">\(Y_{z_j,z_i} \in \{ Y_{00}, Y_{10}, Y_{01}, Y_{11} \}\)</span>, where an untreated unit with an untreated cluster neighbor is defined as <span class="math inline">\(Y_{00}\)</span>, an untreated unit with a treated cluster neighbor as <span class="math inline">\(Y_{10}\)</span>, a treated unit with an untreated cluster neighbor as <span class="math inline">\(Y_{01}\)</span>, and a treated unit with a treated cluster neighbor as <span class="math inline">\(Y_{11}\)</span>. When we conduct a cluster-randomized experiment, we typically assume that a unit’s outcome is not a function of the treatment status of the units with whom it shares a cluster, or formally <span class="math inline">\(Y_{01}=Y_{11}=Y_1\)</span> and <span class="math inline">\(Y_{10}=Y_{00}=Y_0\)</span>. Yet, for all sorts of reasons this may not be the case: depending on whom someone finds themselves in the same cluster with, and whether or not that cluster is assigned to treatment, their outcomes may be very different.</p>
<p>Consider an experiment in which five pairs of students living in dorms are randomly assigned to either receive or not receive a food subsidy, and their stated well-being is the outcome of interest. Let us assume that four students are vegetarian (V) and six are meat-eaters (M). When a VV, MM, or VM pair is assigned to control, they do not receive the subsidy and their well-being is unaffected. However, when assigned to treatment, VM pairs quarrel and this reduces their well-being, whereas VV and MM pairs do not fight and are affected only by the treatment. Let us denote <span class="math inline">\(x_k \in \{0,1\}\)</span> an indicator for whether the pair is mismatched, where the unit’s outcome is denoted <span class="math inline">\(Y_{z_j,z_j,x_k}\)</span>. This implies that <span class="math inline">\(Y_{110} = Y_1\)</span> and <span class="math inline">\(Y_{000} = Y_{001} = Y_0\)</span>, whereas <span class="math inline">\(Y_{111} \neq Y_1\)</span>. To understand how this matters, let us simulate such an experiment.</p>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-17_1e30a3a68d89dda752aed88bdc3be4a9">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create experimental data</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"V"</span>,.<span class="dv">4</span><span class="sc">*</span>N),<span class="fu">rep</span>(<span class="st">"M"</span>,.<span class="dv">6</span><span class="sc">*</span>N))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>ID <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(types)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>baseline <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(ID))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The true treatment effect is 5</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>true_ATE <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># If a pair is mismatched (VM, MV), they get a spillover of -10</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>spillover_or_not <span class="ot">&lt;-</span> <span class="cf">function</span>(type_i,type_j){</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(type_i<span class="sc">==</span>type_j,<span class="at">yes =</span> <span class="dv">0</span>,<span class="at">no =</span> <span class="sc">-</span><span class="dv">10</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"># A function for forming pairs</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>form_pairs <span class="ot">&lt;-</span> <span class="cf">function</span>(ID,types){</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">length</span>(ID)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(N<span class="sc">/</span><span class="dv">2</span>),<span class="dv">2</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  pair_place <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="fu">c</span>(N<span class="sc">/</span><span class="dv">2</span>,N<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  ID_draw <span class="ot">&lt;-</span> <span class="fu">sample</span>(ID)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  type_i <span class="ot">&lt;-</span> types[ID_draw]</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  pair_1 <span class="ot">&lt;-</span> type_i[pair_place<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  pair_2 <span class="ot">&lt;-</span> type_i[pair_place<span class="sc">==</span><span class="dv">2</span>]</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  ID_j_1 <span class="ot">&lt;-</span> ID_draw[pair_place<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  ID_j_2 <span class="ot">&lt;-</span> ID_draw[pair_place<span class="sc">==</span><span class="dv">2</span>]</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  type_j <span class="ot">&lt;-</span> <span class="fu">c</span>(pair_2,pair_1)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  j <span class="ot">&lt;-</span> <span class="fu">c</span>(ID_j_2,ID_j_1)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">i =</span> ID_draw,<span class="at">j =</span> j,<span class="at">k =</span> k, <span class="at">type_i =</span> type_i, <span class="at">type_j =</span> type_j))</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="co"># A function for assigning treatment and revealing the outcome</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>assign_reveal_est <span class="ot">&lt;-</span> <span class="cf">function</span>(k,i,effect,spillover){</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  Z <span class="ot">&lt;-</span> (k <span class="sc">%in%</span> <span class="fu">sample</span>(k,N<span class="sc">/</span><span class="dv">2</span>))<span class="sc">*</span><span class="dv">1</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> baseline[i] <span class="sc">+</span> Z<span class="sc">*</span>effect <span class="sc">+</span> Z<span class="sc">*</span>spillover</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(Y[Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(Y[Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="co"># A function for simulating the experiment</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>simulate_exp <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">form_pairs</span>(ID,types)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>  spillover <span class="ot">&lt;-</span> <span class="fu">spillover_or_not</span>(data<span class="sc">$</span>type_i,data<span class="sc">$</span>type_j)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  estimate <span class="ot">&lt;-</span> <span class="fu">assign_reveal_est</span>(<span class="at">k =</span> data<span class="sc">$</span>k,<span class="at">effect =</span> true_ATE,<span class="at">spillover =</span> spillover,<span class="at">i =</span> data<span class="sc">$</span>i)</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(estimate)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the effects one thousand times</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>est_effects <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="at">n =</span> <span class="dv">1000</span>,<span class="at">expr =</span> <span class="fu">simulate_exp</span>())</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the estimates as bars, the expected ATE in blue, and the true ATE in red</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(est_effects,<span class="at">breaks =</span> <span class="dv">100</span>,<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">7</span>,<span class="dv">7</span>))</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> true_ATE,<span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">mean</span>(est_effects,<span class="at">na.rm =</span> T),<span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="cluster-random_en_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As the plot above shows, this is a biased estimator of the true individual level treatment effect, <span class="math inline">\(Y_{01} - Y_{00}\)</span>. In expectation, we estimate an effect close to 0, obtaining very negative effects in almost half of the simulations of this experiment. The key point here is that the estimand is changed: rather than the ATE, we obtain a combination of the true treatment effect among those who are matched (do not experience spillovers) <span class="math inline">\(E[Y_{110}-Y_{00x_k}]\)</span>, and the combined treatment and spillover effect for those who are unmatched <span class="math inline">\(E[Y_{111}-Y_{00x_k}]\)</span>. Crucially, however, we cannot identify the impact of the spillover, <span class="math inline">\(E[Y_{101}-Y_{00x_k}]\)</span>, independently of the direct effect. This is because the randomization is clustered: it is not possible to observe <span class="math inline">\(Y_{101}\)</span> in a cluster-randomized scheme, because all units within a cluster are always treated. Generally speaking, this issue is true of any cluster-randomized study: in order to make the claim that we identify the individual-level effect of the treatment, we must assume that <span class="math inline">\(Y_{11}=Y_{1}\)</span> and <span class="math inline">\(Y_{00}=Y_{0}\)</span>.</p>
</section>
<section id="what-to-do-about-within-cluster-spillovers" class="level1">
<h1>7 What to do about within-cluster spillovers</h1>
<p>If there are strong reasons to believe that intra-cluster spillovers occur, then researchers can take different approaches depending on the manner in which clusters are formed. In some studies researchers must themselves sort units into groups for the purposes of experimentation: for example, in a study involving a vocational programme, the researcher may be able to decide who is recruited into which class. In such cases, if the researcher can make plausible assumptions about spillovers, then the individual-level treatment effect may be recoverable.</p>
<p>Consider a researcher conducting the previous study above who correctly assumed that spillovers would occur between mismatched pairs. In this case, the researcher can recover the true individual treatment effect by forming clusters that are not susceptible to spillover.</p>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-18_cd909ee83fbf1b2f8a20a51372fb44e2">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>form_matched_pairs <span class="ot">&lt;-</span> <span class="cf">function</span>(ID,types){</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  pair_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">unique</span>(types),<span class="cf">function</span>(type){</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    ID <span class="ot">&lt;-</span> ID[types <span class="sc">==</span> type]</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    types <span class="ot">&lt;-</span> types[types <span class="sc">==</span> type]</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    draw_ID <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(types)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    matched_pairs <span class="ot">&lt;-</span> <span class="fu">form_pairs</span>(<span class="at">ID =</span> draw_ID,<span class="at">types =</span> types)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    matched_pairs<span class="sc">$</span>i <span class="ot">&lt;-</span> ID[matched_pairs<span class="sc">$</span>i]</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    matched_pairs<span class="sc">$</span>j <span class="ot">&lt;-</span> ID[matched_pairs<span class="sc">$</span>j]</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    matched_pairs<span class="sc">$</span>k <span class="ot">&lt;-</span> <span class="fu">paste0</span>(type,<span class="st">"_"</span>,matched_pairs<span class="sc">$</span>k)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(matched_pairs)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pair_list[[<span class="dv">1</span>]],pair_list[[<span class="dv">2</span>]])</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>simulate_matched_exp <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">form_matched_pairs</span>(ID,types)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  spillover <span class="ot">&lt;-</span> <span class="fu">spillover_or_not</span>(data<span class="sc">$</span>type_i,data<span class="sc">$</span>type_j)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  estimate <span class="ot">&lt;-</span> <span class="fu">assign_reveal_est</span>(<span class="at">k =</span> data<span class="sc">$</span>k,<span class="at">effect =</span> true_ATE,<span class="at">spillover =</span> spillover,<span class="at">i =</span> data<span class="sc">$</span>i)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(estimate)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the effects one thousand times</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>est_matched_effects <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="at">n =</span> <span class="dv">1000</span>,<span class="at">expr =</span> <span class="fu">simulate_matched_exp</span>())</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(est_matched_effects,<span class="at">breaks =</span> <span class="dv">100</span>,<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">7</span>,<span class="dv">7</span>))</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> true_ATE,<span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">mean</span>(est_matched_effects,<span class="at">na.rm =</span> T),<span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="cluster-random_en_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In the case that researchers are not able to control how clusters are formed, they can still investigate cluster-level heterogeneity in treatment effects as a way of understanding possible spillovers. However, in both cases, assumptions must be made about the nature of spillovers. Strictly speaking, these cannot be causally identified due to the unobservability of the outcomes <span class="math inline">\(Y_{01}\)</span> and <span class="math inline">\(Y_{10}\)</span>. Ultimately, one would need to combine clustered and non-clustered randomization schemes in order to estimate the effects of intra-cluster spillover, <span class="math inline">\(Y_{11} - Y_{01}\)</span> and <span class="math inline">\(Y_{01} - Y_{00}\)</span>. Therefore, in the interests of interpreting results correctly, researchers should be careful when defining their estimand to take account of the potential for intra-cluster spillover.</p>
</section>
<section id="performance-of-design--vs.-model-based-analyses-of-clustered-studies" class="level1">
<h1>8 Performance of design- vs.&nbsp;model-based analyses of clustered studies</h1>
<p>In our discussion of information loss, we assessed approaches that require (1) that treatment was randomized as planned and (2) that the treatment assigned to one unit did not change the potential outcomes for any other unit. In cases where these assumptions may be violated, it is sometimes simpler to specify statistical models that attempt to describe the features of complex designs. Even if we do not believe the models as scientific descriptions of a known process, this can be a more informative and flexible way of analyzing an experiment than to derive complex new expressions for design-based estimators.</p>
<p>In model-based approaches, the sampling distribution of an estimator is approximated using probability distributions to characterize our uncertainty about unknown quantities, such as the true treatment effect or the true mean of the outcome at the cluster level. Such approaches are referred to as ‘model-based’, because they depict causal relationships as arising from interrelated probability distributions. Often, such approaches use ‘multilevel models’, in which unknown parameters — such as differences between clusters — are themselves understood as arising from probability distributions. Thus, for example, there might be a model for individual-level outcomes, whose intercept and/or coefficients vary from one cluster to another. In this manner, it is possible to model the ‘effect of being a unit in cluster A’, separately from the estimation of the treatment effect. The advantage of such approaches is that they allow for ‘partial pooling’ of the variance in the population and the variance among clusters. When a given cluster is poorly estimated, it contributes less weight to the estimation, and vice versa. Such models therefore often work well in situations where there is very little data in some clusters: through the specification of a Bayesian posterior distribution, they are able to leverage information from all parts of the study. The trade-off is that such assumption-heavy models are only correct to the extent that the assumptions underlying them are correct.</p>
<p>Here we show that the estimated effect is the same whether we use a simple difference of means (via OLS) or a multilevel model in our very simplified cluster randomized trial setup.</p>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-19_fc6060f4b23da403e8ab7deb50f5d35c">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>simple_OLS <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> Z,<span class="at">data =</span> J_30_clusters)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>multilevel <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Y <span class="sc">~</span> Z <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> j),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> J_30_clusters,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">lmerControl</span>(<span class="at">optimizer =</span> <span class="st">"bobyqa"</span>),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">REML =</span> <span class="cn">TRUE</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">round</span>(<span class="fu">data.frame</span>(</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">OLS=</span><span class="fu">coef</span>(simple_OLS)[<span class="st">"Z"</span>],<span class="at">Multilevel=</span><span class="fu">fixef</span>(multilevel)[<span class="st">"Z"</span>]</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  ),<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">OLS</th>
<th style="text-align: right;">Multilevel</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Z</td>
<td style="text-align: right;">-0.13</td>
<td style="text-align: right;">-0.13</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The confidence intervals differ even though the estimates are the same — and there is more than one way to calculate confidence intervals and hypothesis tests for multilevel models. The software in R <span class="citation" data-cites="bates_et_al_2014lme4">(<a href="#ref-bates_et_al_2014lme4" role="doc-biblioref">Bates et al. 2015</a>)</span> includes three methods by default and <span class="citation" data-cites="gelman2006data">Gelman and Hill (<a href="#ref-gelman2006data" role="doc-biblioref">2006</a>)</span> recommend MCMC sampling from the implied posterior. Here we focus on the Wald method only because it is the fastest to compute.</p>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-20_b331f58f328aa4e42576b600608416f5">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This function calculates confidence intervals for linear models</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with custom variance-covariance matrices</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>confint_HC<span class="ot">&lt;-</span><span class="cf">function</span> (coefficients, df, <span class="at">level =</span> <span class="fl">0.95</span>, vcov_mat, ...) {</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> level)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> <span class="fu">c</span>(a, <span class="dv">1</span> <span class="sc">-</span> a)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  fac <span class="ot">&lt;-</span> <span class="fu">qt</span>(a, df)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  ses <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(vcov_mat))</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  coefficients <span class="sc">+</span> ses <span class="sc">%o%</span> fac</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>simple_OLS_CI <span class="ot">&lt;-</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">confint_HC</span>(</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">coefficients =</span> <span class="fu">coef</span>(simple_OLS),</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov_mat =</span> <span class="fu">RCSE</span>(</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> simple_OLS,</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cluster =</span> J_30_clusters<span class="sc">$</span>j,</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">return_cov =</span> <span class="cn">TRUE</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> simple_OLS<span class="sc">$</span>df.residual</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  )[<span class="st">"Z"</span>, ]</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>multi_wald_CI <span class="ot">&lt;-</span> lme4<span class="sc">::</span><span class="fu">confint.merMod</span>(</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  multilevel,</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">parm =</span> <span class="st">"Z"</span>, <span class="at">method =</span> <span class="st">"Wald"</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>)[<span class="st">"Z"</span>, ]</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>multi_profile_CI <span class="ot">&lt;-</span> lme4<span class="sc">::</span><span class="fu">confint.merMod</span>(</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  multilevel,</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">parm =</span> <span class="dv">4</span>, <span class="at">method =</span> <span class="st">"profile"</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>)[<span class="st">"Z"</span>, ]</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">round</span>(<span class="fu">rbind</span>(</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">Design_Based_CI =</span> simple_OLS_CI,</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model_Based_Wald_CI =</span> multi_wald_CI,</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model_Based_Profile_CI =</span> multi_profile_CI</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>),<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">2.5 %</th>
<th style="text-align: right;">97.5 %</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Design_Based_CI</td>
<td style="text-align: right;">-0.416</td>
<td style="text-align: right;">0.156</td>
</tr>
<tr class="even">
<td style="text-align: left;">Model_Based_Wald_CI</td>
<td style="text-align: right;">-0.421</td>
<td style="text-align: right;">0.161</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Model_Based_Profile_CI</td>
<td style="text-align: right;">-0.420</td>
<td style="text-align: right;">0.161</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can calculate an estimate of the ICC directly from the model quantities (the variance of the Normal prior that represents the cluster-to-cluster differences in the intercept over the total variance of the Normal posterior).</p>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-21_65ecfd8caea22c4013e27d2f9ec0bbee">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>VC <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(lme4<span class="sc">:::</span><span class="fu">VarCorr.merMod</span>(multilevel))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">c</span>(<span class="at">ICC =</span> VC<span class="sc">$</span>vcov[<span class="dv">1</span>] <span class="sc">/</span> <span class="fu">sum</span>(VC<span class="sc">$</span>vcov)),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> ICC 
0.09 </code></pre>
</div>
</div>
<p>In order to assess the performance of this model-based approach, as opposed to the robust-clustered standard-error (RCSE) and cluster-aggregated approaches outlined above, we can check how often the different approaches falsely reject the sharp null hypothesis of no effects for any unit, when we know that this null is true.</p>
<p>To do so, we write a function that firstly breaks the relationship between the treatment assignment and the outcome by randomly shuffling the assignment, and then tests whether 0 is in the 95% confidence interval for each of the three approaches, as it should be. Recall that, valid tests would have error rates within 2 simulation standard errors of .95 - this would mean that a correct null hypothesis would be rejected no more than 5% of the time.</p>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-22_35324ab941709cfa1b9d621b2d071d87">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a function for checking whether 0 is in the confidence interval of</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the RCSE, cluster-aggregated, and multilevel estimation approaches</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>sim_0_ate <span class="ot">&lt;-</span> <span class="cf">function</span>(J,Y) {</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   Make the true relationship between treatment and outcomes equal zero by</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   shuffling Z but not revealing new potential outcomes</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  z.sim <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(J), <span class="fu">max</span>(J) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  Z_new <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(J <span class="sc">%in%</span> z.sim <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate using the linear model for RCSE</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  linear_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> Z_new)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  linear_RCSE <span class="ot">&lt;-</span> <span class="fu">RCSE</span>(</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> linear_fit,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cluster =</span> J,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">return_cov =</span> <span class="cn">TRUE</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  linear_CI <span class="ot">&lt;-</span> <span class="fu">confint_HC</span>(</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">coefficients =</span> <span class="fu">coef</span>(linear_fit),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>                      <span class="at">vcov_mat =</span> linear_RCSE,</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> linear_fit<span class="sc">$</span>df.residual</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  )[<span class="st">"Z_new"</span>, ]</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if the confidence interval bounds 0</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  zero_in_CI_RCSE <span class="ot">&lt;-</span> (<span class="dv">0</span> <span class="sc">&gt;=</span> linear_CI[<span class="dv">1</span>]) <span class="sc">&amp;</span> (<span class="dv">0</span> <span class="sc">&lt;=</span> linear_CI[<span class="dv">2</span>])</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate using cluster-aggregated approach (Hansen and Bowers 2008)</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  Yj <span class="ot">&lt;-</span> <span class="fu">tapply</span>(Y, J, sum)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  Zj <span class="ot">&lt;-</span> <span class="fu">tapply</span>(Z_new, J, mean)</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  m0 <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">table</span>(J))</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  n  <span class="ot">&lt;-</span> <span class="fu">length</span>(Zj)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> <span class="fu">sum</span>(Zj)</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Do Hansen and Bowers 2008 based test for difference of means</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># with cluster-level assignment (assuming same size clusters)</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>  ones <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(Yj))</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  dp   <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(Zj,Yj) <span class="sc">*</span> (n <span class="sc">/</span> (m0 <span class="sc">*</span> nt <span class="sc">*</span> (n <span class="sc">-</span> nt))) <span class="sc">-</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">crossprod</span>(ones,Yj) <span class="sc">/</span> (m0 <span class="sc">*</span> (n <span class="sc">-</span> nt))</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>  obs_ATE <span class="ot">&lt;-</span> dp[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Two tailed p-value for the test of the null of no effects</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>  Vdp <span class="ot">&lt;-</span> (n <span class="sc">/</span> (m0 <span class="sc">*</span> nt <span class="sc">*</span> (n <span class="sc">-</span> nt))) <span class="sc">*</span> (<span class="fu">var</span>(Yj) <span class="sc">/</span> m0)</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>  HB_pval <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">pnorm</span>(<span class="fu">abs</span>(obs_ATE) <span class="sc">/</span> <span class="fu">sqrt</span>(Vdp)))</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if the p-value is greater than .05</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>  zero_not_rej_HB <span class="ot">&lt;-</span> HB_pval <span class="sc">&gt;=</span> .<span class="dv">05</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate using a multilevel model</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>  multilevel_fit <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Y <span class="sc">~</span> Z_new <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> J),</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">lmerControl</span>(<span class="at">optimizer =</span> <span class="st">"bobyqa"</span>),</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">REML =</span> <span class="cn">FALSE</span></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>  multilevel_CI <span class="ot">&lt;-</span> lme4<span class="sc">:::</span><span class="fu">confint.merMod</span>(</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>    multilevel_fit,</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">parm =</span> <span class="st">"Z_new"</span>, <span class="at">method =</span> <span class="st">"Wald"</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if the confidence interval bounds 0</span></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>  zero_in_CI_multilevel <span class="ot">&lt;-</span> (<span class="dv">0</span> <span class="sc">&gt;=</span> multilevel_CI[<span class="dv">1</span>]) <span class="sc">&amp;</span> (<span class="dv">0</span> <span class="sc">&lt;=</span> multilevel_CI[<span class="dv">2</span>])</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">ATE =</span> <span class="fu">fixef</span>(multilevel_fit)[<span class="st">"Z_new"</span>],</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">zero_in_CI_RCSE =</span> zero_in_CI_RCSE,</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">zero_not_rej_HB =</span> zero_not_rej_HB,</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">zero_in_CI_multilevel =</span> zero_in_CI_multilevel</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Now simulate each of the estimates 1000 times</span></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>J_4_comparison <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">1000</span>, <span class="fu">sim_0_ate</span>(<span class="at">J =</span> J_4_clusters<span class="sc">$</span>j, <span class="at">Y =</span> J_4_clusters<span class="sc">$</span>Y))</span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>J_4_error_rates <span class="ot">&lt;-</span> <span class="fu">apply</span>(J_4_comparison,<span class="dv">1</span>,mean)</span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>J_4_error_rates[<span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>J_4_error_rates[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>J_10_comparison <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">1000</span>, <span class="fu">sim_0_ate</span>(<span class="at">J =</span> J_10_clusters<span class="sc">$</span>j, <span class="at">Y =</span> J_10_clusters<span class="sc">$</span>Y))</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>J_10_error_rates <span class="ot">&lt;-</span> <span class="fu">apply</span>(J_10_comparison,<span class="dv">1</span>,mean)</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>J_10_error_rates[<span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>J_10_error_rates[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>J_30_comparison <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">1000</span>, <span class="fu">sim_0_ate</span>(<span class="at">J =</span> J_30_clusters<span class="sc">$</span>j, <span class="at">Y =</span> J_30_clusters<span class="sc">$</span>Y))</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>J_30_error_rates <span class="ot">&lt;-</span> <span class="fu">apply</span>(J_30_comparison,<span class="dv">1</span>,mean)</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>J_30_error_rates[<span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>J_30_error_rates[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>J_100_comparison <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">1000</span>, <span class="fu">sim_0_ate</span>(<span class="at">J =</span> J_100_clusters<span class="sc">$</span>j, <span class="at">Y =</span> J_100_clusters<span class="sc">$</span>Y))</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>J_100_error_rates <span class="ot">&lt;-</span> <span class="fu">apply</span>(J_100_comparison,<span class="dv">1</span>,mean)</span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>J_100_error_rates[<span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>J_100_error_rates[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a>error_comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">round</span>(<span class="fu">rbind</span>(</span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>  J_4_error_rates,</span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a>  J_10_error_rates,</span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a>  J_30_error_rates,</span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a>  J_100_error_rates</span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a>),<span class="dv">3</span>))</span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(error_comparison) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Estimated ATE"</span>,</span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"OLS + RCSE"</span>,</span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Cluster-Level"</span>,</span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Multi-Level"</span></span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(error_comparison,<span class="at">align =</span> <span class="st">"c"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 24%">
<col style="width: 20%">
<col style="width: 16%">
<col style="width: 20%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: center;">Estimated ATE</th>
<th style="text-align: center;">OLS + RCSE</th>
<th style="text-align: center;">Cluster-Level</th>
<th style="text-align: center;">Multi-Level</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">J_4_error_rates</td>
<td style="text-align: center;">0.002</td>
<td style="text-align: center;">0.000</td>
<td style="text-align: center;">0.000</td>
<td style="text-align: center;">0.334</td>
</tr>
<tr class="even">
<td style="text-align: left;">J_10_error_rates</td>
<td style="text-align: center;">0.005</td>
<td style="text-align: center;">0.101</td>
<td style="text-align: center;">0.042</td>
<td style="text-align: center;">0.101</td>
</tr>
<tr class="odd">
<td style="text-align: left;">J_30_error_rates</td>
<td style="text-align: center;">0.003</td>
<td style="text-align: center;">0.061</td>
<td style="text-align: center;">0.040</td>
<td style="text-align: center;">0.063</td>
</tr>
<tr class="even">
<td style="text-align: left;">J_100_error_rates</td>
<td style="text-align: center;">-0.001</td>
<td style="text-align: center;">0.058</td>
<td style="text-align: center;">0.052</td>
<td style="text-align: center;">0.059</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In our simple setup, the individual-level approaches behave about the same way: neither the design-based nor the model-based approach produces valid statistical inferences until the number of clusters is at least 30. This makes sense: both approaches rely on central limit theorems so that a Normal law can describe the distribution of the test statistic under the null hypothesis. The cluster-level approach is always valid, but sometimes produces overly large confidence intervals (when the number of clusters is small). When the number of clusters is large (say, 100), then all approaches are equivalent in terms of their error rates. Designs with few clusters should consider either the cluster-level approach using the normal approximation shown here or even direct permutation based approaches to statistical inference.</p>
</section>
<section id="power-analysis-for-clustered-designs" class="level1">
<h1>9 Power analysis for clustered designs</h1>
<p>We want designs that are likely to reject hypotheses inconsistent with the data, and unlikely to reject hypotheses consistent with the data. We’ve seen that the assumptions required for the validity of common tests (typically, large numbers of observations, or large quantities of information in general) are challenged by clustered designs, and the tests which account for clustering can be invalid if the number of clusters is small (or information is low at the cluster level in general). We’ve also seen that we can produce valid statistical tests for hypotheses about the average treatment effect using either Robust Clustered Standard Errors (RCSE), multilevel models or using the cluster-level approach described by <span class="citation" data-cites="hansen2008covariate">Hansen and Bowers (<a href="#ref-hansen2008covariate" role="doc-biblioref">2008</a>)</span>, and that pair-matching can drastically minimize bias in designs with unequal cluster sizes.</p>
<p>The most important rule regarding the statistical power of clustered designs is that more small clusters are better than fewer larger ones. This can be demonstrated through simulated experiments. Generally speaking, the most flexible way to evaluate the power of a design is through simulation, as it allows for complex clustering and blocking schemes, and can incorporate covariates. In the following we use the OLS estimator with Robust Clustered Standard Errors, in order to save on computation time, but the same analysis can be achieved using any estimator and test statistic.</p>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-23_13811283e2460fe7b5913be8ba504162">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A function to test the null hypothesis and the true hypothesis</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>test_H0_and_Htrue <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">J =</span> J,<span class="at">n =</span> n,<span class="at">treatment_effect =</span> treatment_effect,<span class="at">ICC =</span> ICC) {</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make data:</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">make_clustered_data</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">J =</span> J,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">n =</span> n,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">treatment_effect =</span> treatment_effect,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">ICC =</span> ICC</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  linear_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> Z,<span class="at">data =</span> data)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  RCSE_CI <span class="ot">&lt;-</span> <span class="fu">confint_HC</span>(</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">coefficients =</span> <span class="fu">coef</span>(linear_fit),</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov_mat =</span> <span class="fu">RCSE</span>(</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> linear_fit,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cluster =</span> data<span class="sc">$</span>j,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">return_cov =</span> <span class="cn">TRUE</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> linear_fit<span class="sc">$</span>df.residual</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  )[<span class="st">"Z"</span>, ]</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Zero should not be in this CI very often as the null of 0 is false here</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  correct_reject <span class="ot">&lt;-</span> <span class="sc">!</span>((<span class="dv">0</span> <span class="sc">&gt;=</span> RCSE_CI[<span class="dv">1</span>]) <span class="sc">&amp;</span> (<span class="dv">0</span> <span class="sc">&lt;=</span> RCSE_CI[<span class="dv">2</span>]))</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test null of true taus (first attempt is use true, second is to make 0 true)</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reassign village level treatment so that Y is indep of Z --- so true effect is 0</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>Z_new <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>j <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>J, <span class="fu">max</span>(J)<span class="sc">/</span><span class="dv">2</span>), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>  linear_fit_true <span class="ot">&lt;-</span><span class="fu">lm</span>(Y <span class="sc">~</span> Z_new,<span class="at">data =</span> data)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>  RCSE_CI_true <span class="ot">&lt;-</span> <span class="fu">confint_HC</span>(</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">coefficients =</span> <span class="fu">coef</span>(linear_fit_true),</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov_mat =</span> <span class="fu">RCSE</span>(</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> linear_fit_true,</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">cluster =</span> data<span class="sc">$</span>j,</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">return_cov =</span> <span class="cn">TRUE</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> linear_fit<span class="sc">$</span>df.residual</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  )[<span class="st">"Z_new"</span>, ]</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Zero should be in this CI very often as the null of 0 is true here</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  false_positive <span class="ot">&lt;-</span>  <span class="sc">!</span>((<span class="dv">0</span> <span class="sc">&gt;=</span> RCSE_CI_true[<span class="dv">1</span>]) <span class="sc">&amp;</span> (<span class="dv">0</span> <span class="sc">&lt;=</span> RCSE_CI_true[<span class="dv">2</span>]))</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">correct_reject =</span> correct_reject,</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">false_positive =</span> false_positive</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now analyze how power is affected when the number of clusters and the size of clusters vary, holding the ICC constant at .01 and the treatment effect constant at .2. We look both at the power — how often we correctly reject the null of no effect when there really is one - as well as at the error — how often we incorrectly reject the null of no effect when there really isn’t an effect. Typically we want the power to be around .8 and the error rate to be around .5 (when using a 95% confidence level).</p>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-24_1ae864d02384dae842314a9ca4f18d1c">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The numbers of clusters we will consider</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>Js <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">20</span>,<span class="dv">40</span>,<span class="dv">80</span>,<span class="dv">160</span>,<span class="dv">320</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The cluster sizes we will consider</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>n_js <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">20</span>,<span class="dv">40</span>,<span class="dv">80</span>,<span class="dv">160</span>,<span class="dv">320</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty matrix to store the results</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The first stores the power and the second stores the error</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>power_J_n <span class="ot">&lt;-</span> error_J_n <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="cn">NA</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> <span class="fu">length</span>(Js),</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="fu">length</span>(n_js),</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">list</span>(</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"J ="</span>,Js),</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"n_j ="</span>,n_js)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the number of simulations</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through the different cluster numbers</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>( j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Js)){</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop through the different cluster sizes</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(n_js)){</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estimate the power and error rate for each combination</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    test_sims <span class="ot">&lt;-</span> <span class="fu">replicate</span>(</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> sims,</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">expr =</span> <span class="fu">test_H0_and_Htrue</span>(</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">J =</span> Js[j],</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">n =</span> n_js[n],</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">treatment_effect =</span> .<span class="dv">25</span>,</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">ICC =</span> .<span class="dv">01</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    power_error <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(test_sims)</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store them in the matrices</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    power_J_n[j,n] <span class="ot">&lt;-</span> power_error[<span class="dv">1</span>]</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    error_J_n[j,n] <span class="ot">&lt;-</span> power_error[<span class="dv">2</span>]</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the power under the different scenarios</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="fu">matplot</span>(power_J_n, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"b"</span>),<span class="at">pch=</span><span class="dv">1</span>,<span class="at">axes =</span> F,<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">1.5</span>),<span class="at">ylab =</span> <span class="st">"power"</span>)</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side =</span> <span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">rownames</span>(power_J_n),<span class="at">at =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side =</span> <span class="dv">2</span>,<span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,.<span class="dv">25</span>))</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span>.<span class="dv">8</span>)</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">colnames</span>(power_J_n),<span class="at">col =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span> ,<span class="at">pch=</span><span class="dv">1</span>,<span class="at">horiz =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="cluster-random_en_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-25_106f3f3490596510ba7dc324289ce761">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the error rate under the different scenarios</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">matplot</span>(error_J_n, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"b"</span>),<span class="at">pch=</span><span class="dv">1</span>,<span class="at">axes =</span> F,<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,.<span class="dv">5</span>),<span class="at">ylab =</span> <span class="st">"error rate"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side =</span> <span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">rownames</span>(error_J_n),<span class="at">at =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side =</span> <span class="dv">2</span>,<span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,.<span class="dv">25</span>))</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span>.<span class="dv">05</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">colnames</span>(error_J_n),<span class="at">col =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span> ,<span class="at">pch=</span><span class="dv">1</span>,<span class="at">horiz =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="cluster-random_en_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We see that power is always low when the number of clusters is low, regardless of how large the clusters are. Even with huge clusters (with 320 units each), the statistical power of the study is still relatively low when the number of clusters is 8. Similarly, it takes a large number of clusters to power a study with small clusters: although it is sufficient to have many clusters in order to power an experiment, irrespective of cluster size, power increases much more rapidly when the clusters are larger. Note also that while error rates appear systematically related to the number of clusters, the same is not true for cluster sizes.</p>
<p>Next, we can evaluate how the intra-cluster correlation affects power. We will hold the structure of the sample size constant at <span class="math inline">\(J=80,n_j=80\)</span> and <span class="math inline">\(J=160,n_j=160\)</span>, and compare across a range of ICC values, from low (.01) to high (.6).</p>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-26_711acb38c242a1d67b28e6077c8c33d2">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>J_njs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">80</span>,<span class="dv">160</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>ICCs <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,.<span class="dv">6</span>,.<span class="dv">1</span>)<span class="sc">+</span><span class="fu">c</span>(.<span class="dv">01</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>power_ICC <span class="ot">&lt;-</span> error_ICC <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="cn">NA</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> <span class="fu">length</span>(ICCs),</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="fu">length</span>(J_njs),</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">list</span>(</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"ICC ="</span>,ICCs),</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">"J ="</span>,J_njs,<span class="st">"n_j = "</span>,J_njs)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the number of simulations</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through the different ICCs</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ICCs)){</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop through the different cluster sizes</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(J_njs)){</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estimate the power and error rate for each combination</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    test_sims <span class="ot">&lt;-</span> <span class="fu">replicate</span>(</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> sims,</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">expr =</span> <span class="fu">test_H0_and_Htrue</span>(</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">J =</span> J_njs[j],</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">n =</span> J_njs[j],</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">treatment_effect =</span> .<span class="dv">25</span>,</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">ICC =</span> ICCs[i]</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    power_error <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(test_sims)</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store them in the matrices</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    power_ICC[i,j] <span class="ot">&lt;-</span> power_error[<span class="dv">1</span>]</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    error_ICC[i,j] <span class="ot">&lt;-</span> power_error[<span class="dv">2</span>]</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the power under the different scenarios</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="fu">matplot</span>(power_ICC, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"b"</span>),<span class="at">pch=</span><span class="dv">1</span>,<span class="at">axes =</span> F,<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">1.5</span>),<span class="at">ylab =</span> <span class="st">"power (high ICC)"</span>)</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side =</span> <span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">rownames</span>(power_ICC),<span class="at">at =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side =</span> <span class="dv">2</span>,<span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,.<span class="dv">25</span>))</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span>.<span class="dv">8</span>)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">colnames</span>(power_ICC),<span class="at">col =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span> ,<span class="at">pch=</span><span class="dv">1</span>,<span class="at">horiz =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="cluster-random_en_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-27_a67fb1ef60cf80c9e60cef34621f4c1e">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the error rate under the different scenarios</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">matplot</span>(error_ICC, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"b"</span>),<span class="at">pch=</span><span class="dv">1</span>,<span class="at">axes =</span> F,<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,.<span class="dv">5</span>),<span class="at">ylab =</span> <span class="st">"error rate"</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side =</span> <span class="dv">1</span>,<span class="at">labels =</span> <span class="fu">rownames</span>(error_ICC),<span class="at">at =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side =</span> <span class="dv">2</span>,<span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,.<span class="dv">25</span>))</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span>.<span class="dv">05</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">colnames</span>(error_ICC),<span class="at">col =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span> ,<span class="at">pch=</span><span class="dv">1</span>,<span class="at">horiz =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="cluster-random_en_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As this example illustrates, high ICC can severely diminish the statistical power of the study, even with many large clusters.</p>
</section>
<section id="how-to-check-balance-in-clustered-designs" class="level1">
<h1>10 How to check balance in clustered designs</h1>
<p>Randomization checks in clustered designs follow the same form as the preceding discussion. A valid test for a treatment effect is a valid test for placebo or covariate balance. The only difference from our preceding discussion is that one uses a background covariate or baseline outcome — some variable putatively uninfluenced by the treatment — in place of the outcome itself. So, randomization tests with small numbers of clusters may be too quick to declare an experiment ill-randomized if the analyst is not aware of the methods of error-rate analysis that we described above.</p>
<p>One new problem does arise in the context of randomization tests. Often one has many covariates which could be used to detect unlucky imbalances or field problems with the randomization itself. And, if one uses hypothesis tests, then, of course, a valid test which encourages us to declare “imbalance” when <span class="math inline">\(p&lt;.05\)</span> would do so falsely for one in every twenty variables tested. For this reason, we recommend using one-by-one testing as an exploratory tool and using omnibus tests (like the Hotelling T-test or an F-test or the <span class="citation" data-cites="hansen2008covariate">Hansen and Bowers (<a href="#ref-hansen2008covariate" role="doc-biblioref">2008</a>)</span> <span class="math inline">\(d^2\)</span> test), which can combine information across many dependent tests into one test statistic to make balance tests directly. However, these tests must account for the clustered nature of the design: a simple F-test without accounting for the clustered-design will likely mislead an analyst into declaring a design unbalanced and perhaps charging the field staff with a randomization failure.</p>
<p>Since cluster randomized experiments tend to have cluster-level covariates (say, village size, etc..) balance checks at the cluster level make sense and do not require explicit changes to account for clustered-assignment. <span class="citation" data-cites="hansen2008covariate">Hansen and Bowers (<a href="#ref-hansen2008covariate" role="doc-biblioref">2008</a>)</span> develop such a test and provide software to implement it. So, for example, if we had 10 covariates measured at the village level, and we had a large number of villages we could assess an omnibus balance hypothesis using this design-based but large-sample tool.</p>
<p>Here we show only the omnibus test results. The one-by-one assessments that make up the omnibus test are also available in the <code>balance_test</code> object. Here, the omnibus test tell us that we have little information against the null that these observations arose from a randomized study.</p>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-28_398207eca9058559bd27fb8a3b82b643">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RItools)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: SparseM</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'SparseM'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:base':

    backsolve</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: dgof</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dgof'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:stats':

    ks.test</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: replacing previous import 'stats::ks.test' by 'dgof::ks.test' when
loading 'RItools'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits=</span><span class="dv">3</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a village level dataset</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>villages <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(pretend_data,<span class="at">by =</span> <span class="fu">list</span>(<span class="at">village =</span> pretend_data<span class="sc">$</span>j), mean)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate 10 fake covariates</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>villages[<span class="fu">paste</span>(<span class="st">"x"</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,<span class="at">sep=</span><span class="st">""</span>)] <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="fu">nrow</span>(villages)<span class="sc">*</span><span class="dv">10</span>), <span class="at">ncol=</span><span class="dv">10</span>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>balance_formula <span class="ot">&lt;-</span> <span class="fu">reformulate</span>(<span class="fu">paste</span>(<span class="st">"x"</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,<span class="at">sep=</span><span class="st">""</span>), <span class="at">response=</span><span class="st">"Z"</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Do a design-based, large sample balance test</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>balance_test <span class="ot">&lt;-</span><span class="fu">xBalance</span>(balance_formula,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">strata=</span><span class="fu">list</span>(<span class="at">noblocks=</span><span class="cn">NULL</span>),</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data=</span>villages,</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">report =</span> <span class="fu">c</span>(</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"std.diffs"</span>, <span class="st">"z.scores"</span>, <span class="st">"adj.means"</span>,</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adj.mean.diffs"</span>, <span class="st">"chisquare.test"</span>, <span class="st">"p.values"</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="co"># The results of the 1-by-1 balance tests</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">round</span>(balance_test<span class="sc">$</span>results,<span class="dv">2</span>),<span class="at">align =</span> <span class="st">"c"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 3%">
<col style="width: 17%">
<col style="width: 19%">
<col style="width: 18%">
<col style="width: 18%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: center;">Control.noblocks</th>
<th style="text-align: center;">Treatment.noblocks</th>
<th style="text-align: center;">adj.diff.noblocks</th>
<th style="text-align: center;">std.diff.noblocks</th>
<th style="text-align: center;">z.noblocks</th>
<th style="text-align: center;">p.noblocks</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">x1</td>
<td style="text-align: center;">-0.24</td>
<td style="text-align: center;">-0.02</td>
<td style="text-align: center;">0.22</td>
<td style="text-align: center;">0.26</td>
<td style="text-align: center;">0.43</td>
<td style="text-align: center;">0.67</td>
</tr>
<tr class="even">
<td style="text-align: left;">x2</td>
<td style="text-align: center;">0.68</td>
<td style="text-align: center;">-0.11</td>
<td style="text-align: center;">-0.78</td>
<td style="text-align: center;">-1.01</td>
<td style="text-align: center;">-1.47</td>
<td style="text-align: center;">0.14</td>
</tr>
<tr class="odd">
<td style="text-align: left;">x3</td>
<td style="text-align: center;">0.37</td>
<td style="text-align: center;">-0.20</td>
<td style="text-align: center;">-0.57</td>
<td style="text-align: center;">-0.47</td>
<td style="text-align: center;">-0.77</td>
<td style="text-align: center;">0.44</td>
</tr>
<tr class="even">
<td style="text-align: left;">x4</td>
<td style="text-align: center;">1.15</td>
<td style="text-align: center;">0.30</td>
<td style="text-align: center;">-0.86</td>
<td style="text-align: center;">-0.71</td>
<td style="text-align: center;">-1.11</td>
<td style="text-align: center;">0.27</td>
</tr>
<tr class="odd">
<td style="text-align: left;">x5</td>
<td style="text-align: center;">-0.16</td>
<td style="text-align: center;">0.04</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">0.14</td>
<td style="text-align: center;">0.24</td>
<td style="text-align: center;">0.81</td>
</tr>
<tr class="even">
<td style="text-align: left;">x6</td>
<td style="text-align: center;">1.08</td>
<td style="text-align: center;">-0.54</td>
<td style="text-align: center;">-1.62</td>
<td style="text-align: center;">-1.55</td>
<td style="text-align: center;">-1.97</td>
<td style="text-align: center;">0.05</td>
</tr>
<tr class="odd">
<td style="text-align: left;">x7</td>
<td style="text-align: center;">-0.04</td>
<td style="text-align: center;">0.08</td>
<td style="text-align: center;">0.12</td>
<td style="text-align: center;">0.09</td>
<td style="text-align: center;">0.15</td>
<td style="text-align: center;">0.88</td>
</tr>
<tr class="even">
<td style="text-align: left;">x8</td>
<td style="text-align: center;">0.76</td>
<td style="text-align: center;">0.12</td>
<td style="text-align: center;">-0.63</td>
<td style="text-align: center;">-0.58</td>
<td style="text-align: center;">-0.92</td>
<td style="text-align: center;">0.36</td>
</tr>
<tr class="odd">
<td style="text-align: left;">x9</td>
<td style="text-align: center;">1.32</td>
<td style="text-align: center;">0.37</td>
<td style="text-align: center;">-0.95</td>
<td style="text-align: center;">-1.30</td>
<td style="text-align: center;">-1.76</td>
<td style="text-align: center;">0.08</td>
</tr>
<tr class="even">
<td style="text-align: left;">x10</td>
<td style="text-align: center;">-0.33</td>
<td style="text-align: center;">0.28</td>
<td style="text-align: center;">0.61</td>
<td style="text-align: center;">0.51</td>
<td style="text-align: center;">0.82</td>
<td style="text-align: center;">0.41</td>
</tr>
</tbody>
</table>
</div>
</div>
<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>
<div class="hidecode" onclick="doclick(this);">
[Click to show code]
</div>
<div class="cell" data-hash="cluster-random_en_cache/html/unnamed-chunk-29_6d3c7548bee01805f7b32d936521d43d">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The overall omnibus p-value</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">round</span>(balance_test<span class="sc">$</span>overall,<span class="dv">2</span>),<span class="at">align =</span> <span class="st">"c"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: center;">chisquare</th>
<th style="text-align: center;">df</th>
<th style="text-align: center;">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">noblocks</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">0.44</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In this case, we cannot reject the omnibus hypotheses of balance even though, as we expected, we have a few covariates with falsely low <span class="math inline">\(p\)</span>-values. One way to interpret this omnibus result is to say that such imbalances on a few covariates would not appreciably change any statistical inferences we make about treatment effects as long as these covariates did not strongly predict outcomes in the control group. Alternatively, we could say that any large experiment can tolerant chance imbalance on a few covariates (no more than roughly 5% if we are using <span class="math inline">\(\alpha=.05\)</span> as our threshold to reject hypotheses).</p>
</section>
<section id="references" class="level1">




</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-arceneaux2009modeling" class="csl-entry" role="doc-biblioentry">
Arceneaux, Kevin, and David W Nickerson. 2009. <span>“Modeling Certainty with Clustered Data: A Comparison of Methods.”</span> <em>Political Analysis</em> 17 (2): 177–90.
</div>
<div id="ref-bates_et_al_2014lme4" class="csl-entry" role="doc-biblioentry">
Bates, Douglas, Martin Mächler, Ben Bolker, and Steve Walker. 2015. <span>“Fitting Linear Mixed-Effects Models Using <span class="nocase">lme4</span>.”</span> <em>Journal of Statistical Software</em> 67 (1): 1–48. <a href="https://doi.org/10.18637/jss.v067.i01">https://doi.org/10.18637/jss.v067.i01</a>.
</div>
<div id="ref-gelman2006data" class="csl-entry" role="doc-biblioentry">
Gelman, Andrew, and Jennifer Hill. 2006. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge university press.
</div>
<div id="ref-hansen2008covariate" class="csl-entry" role="doc-biblioentry">
Hansen, Ben B, and Jake Bowers. 2008. <span>“Covariate Balance in Simple, Stratified and Clustered Comparative Studies.”</span> <em>Statistical Science</em>, 219–36.
</div>
<div id="ref-imai2009essential" class="csl-entry" role="doc-biblioentry">
Imai, Kosuke, Gary King, and Clayton Nall. 2009. <span>“The Essential Role of Pair Matching in Cluster-Randomized Experiments, with Application to the Mexican Universal Health Insurance Evaluation.”</span> <em>Statistical Science</em> 24 (1): 29–53.
</div>
<div id="ref-kish1965survey" class="csl-entry" role="doc-biblioentry">
Kish, Leslie. 1965. <em>Survey Sampling</em>. New York: John Wiley &amp; Sons.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This guide was originally written by Jake Bowers and Ashlea Rundlett (22 Nov 2014). Updates made by Jasper Cooper (25 Aug 2015) and Anna Wilke (Mar 2022).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>